# MCP 서버들을 위한 Python 3.12 기반 이미지
#
# ⚠️ 중요: uv.lock 파일을 통해 정확한 의존성 버전이 보장됩니다.
#    pyproject.toml 변경 시 반드시 `uv lock` 실행 후 uv.lock을 커밋하세요.

FROM python:3.12-slim

# 작업 디렉토리 설정
WORKDIR /app

# 시스템 패키지 업데이트 및 필요한 도구 설치
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# UV 패키지 매니저 설치 (최신 안정 버전)
RUN pip install --no-cache-dir uv

# ============================================
# 의존성 설치 (uv.lock 기반 재현 가능한 빌드)
# ============================================

# 1. 의존성 정의 파일 복사
#    - pyproject.toml: 의존성 선언
#    - uv.lock: 정확한 버전 고정 (재현 가능한 빌드의 핵심!)
COPY pyproject.toml uv.lock LICENSE ./

# 2. 프로젝트 소스 복사 (uv sync에서 프로젝트 설치에 필요)
COPY src/ ./src/

# 3. 의존성 설치 (uv.lock 기반 정확한 버전 설치)
#    --frozen: lock 파일을 절대 업데이트하지 않음 (재현성 보장)
#    빌드 시 lock 파일과 pyproject.toml이 불일치하면 에러 발생
RUN uv sync --frozen

# 4. 개발 모드로 패키지 설치
RUN uv pip install -e .

# 환경변수 설정
ENV PYTHONPATH=/app
ENV HOST=0.0.0.0
ENV LOG_LEVEL=info

# 헬스체크를 위한 curl 설정
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:${PORT}/health || exit 1

# 각 서버별 포트 노출 (docker-compose에서 설정)
EXPOSE 3000 3001 3002

# 기본 실행: uvicorn을 import-string + --factory로 실행
# docker-compose에서는 command로 APP과 포트만 덮어씁니다.
ENTRYPOINT ["uv", "run", "uvicorn"]
CMD ["mcp_servers.tavily_search.server:create_app", "--host", "0.0.0.0", "--port", "3001", "--factory"]